source "amazon-ebssurrogate" "arm64" {
  # Unable to use "source_ami_filter" with the correct wildcards for getting arm64 without potentially matching a beta
  # Use https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Images:visibility=public-images;ownerAlias=309956199498;architecture=arm64;name=RHEL-8;sort=name
  # when ready to bump to a newer AMI.
  source_ami = "ami-029ba835ddd43c34f"

  instance_type = "m6g.large"
  region = "us-east-1"

  launch_block_device_mappings {
    device_name = "/dev/sdf"
    delete_on_termination = true
    volume_size = 8
    volume_type = "gp2"
  }

  run_tags = {
    Name = "Packer EL8 Builder (arm64)"
  }
  run_volume_tags = {
    Name = "Packer EL8 Builder"
  }

  communicator = "ssh"
  ssh_pty = true
  ssh_username = "ec2-user"
  ssh_timeout = "5m"

  ami_name = "centos-8-arm64"
  ami_description = "CentOS 8 (arm64)"
  ami_virtualization_type = "hvm"
  ami_architecture = "arm64"
  ena_support = true
  ami_regions = []
  ami_root_device {
    source_device_name = "/dev/sdf"
    device_name = "/dev/sda1"
    delete_on_termination = true
    volume_size = 8
    volume_type = "gp2"
  }

  tags = {
    Name = "CentOS 8 (arm64)"
    BuildTime = timestamp()
  }
}

source "amazon-ebssurrogate" "x86_64" {
  # Unable to use "source_ami_filter" with the correct wildcards for getting x86_64 without potentially matching a beta
  # Use https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Images:visibility=public-images;ownerAlias=309956199498;architecture=x86_64;name=RHEL-8;sort=name
  # when ready to bump to a newer AMI.
  source_ami = "ami-098f16afa9edf40be"

  instance_type = "m5a.xlarge"
  region = "us-east-1"

  launch_block_device_mappings {
    device_name = "/dev/sdf"
    delete_on_termination = true
    volume_size = 8
    volume_type = "gp2"
  }

  run_tags = {
    Name = "Packer EL8 Builder (x86_64)"
  }
  run_volume_tags = {
    Name = "Packer EL8 Builder"
  }

  communicator = "ssh"
  ssh_pty = true
  ssh_username = "ec2-user"
  ssh_timeout = "5m"

  ami_name = "centos-8-x86_64"
  ami_description = "CentOS 8 (x86_64)"
  ami_virtualization_type = "hvm"
  ami_architecture = "x86_64"
  ena_support = true
  sriov_support = true
  ami_regions = []
  ami_root_device {
    source_device_name = "/dev/sdf"
    device_name = "/dev/sda1"
    delete_on_termination = true
    volume_size = 8
    volume_type = "gp2"
  }

  tags = {
    Name = "CentOS 8 (x86_64)"
    BuildTime = timestamp()
  }
}

build {
  sources = [
    "source.amazon-ebssurrogate.arm64",
    "source.amazon-ebssurrogate.x86_64",
  ]

  "provisioners": [
    {
      "type": "ansible",
      "sftp_command": "/usr/libexec/openssh/sftp-server",
      "playbook_file": "./playbook.yml"
    }
  ]
}
